---
# =========================
# 1) Bootstrap: ensure Python exists on the remote so Ansible can run modules
# =========================
- hosts: ranch
  gather_facts: no
  become: yes
  tasks:
    - name: Install Python so Ansible can work
      raw: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -y
        apt-get install -y python3 python3-apt sudo
      changed_when: false

# =========================
# 2) Converge server to desired state
# =========================
- hosts: ranch
  become: yes
  gather_facts: yes
  vars_files:
    - vars.yml
  vars:
    docker_arch_map:
      x86_64: amd64
      aarch64: arm64
      armv7l: armhf
      armv6l: arm
  tasks:
    - name: Remove any stale Docker repo file (previous runs)
      ansible.builtin.file:
        path: /etc/apt/sources.list.d/docker.list
        state: absent
      tags: [packages]

    # ---------- FIREWALL: disable host firewall early (use provider firewall) ----------
    - name: Check if ufw systemd unit exists
      ansible.builtin.stat:
        path: /lib/systemd/system/ufw.service
      register: ufw_unit
      tags: [firewall]

    - name: Disable ufw if present
      ansible.builtin.command: ufw disable
      register: ufw_disable
      changed_when: "'inactive' in (ufw_disable.stdout | lower) or 'not running' in (ufw_disable.stdout | lower) or 'disabled' in (ufw_disable.stdout | lower) or ufw_disable.rc == 0"
      failed_when: ufw_disable.rc not in [0,1]  # ufw returns 1 when already disabled
      when: ufw_unit.stat.exists
      tags: [firewall]

    - name: Stop/disable ufw service if present
      ansible.builtin.systemd:
        name: ufw
        state: stopped
        enabled: false
        masked: true
      when: ufw_unit.stat.exists
      tags: [firewall]

    - name: Flush iptables/ip6tables and set ACCEPT policies (no host firewall)
      ansible.builtin.shell: |
        set -e
        for tbl in filter nat mangle raw; do
          iptables -t "$tbl" -F || true
          iptables -t "$tbl" -X || true
          ip6tables -t "$tbl" -F || true
          ip6tables -t "$tbl" -X || true
        done
        iptables -P INPUT ACCEPT
        iptables -P FORWARD ACCEPT
        iptables -P OUTPUT ACCEPT
        ip6tables -P INPUT ACCEPT
        ip6tables -P FORWARD ACCEPT
        ip6tables -P OUTPUT ACCEPT
      tags: [firewall]

    # ---------- HOSTNAME ----------
    - name: Derive host/domain values (inventory overrides vars.yml)
      ansible.builtin.set_fact:
        _hostname: "{{ hostvars[inventory_hostname].hostname | default(hostname, true) | default(ansible_hostname, true) | default('') }}"
        _domain: "{{ hostvars[inventory_hostname].domain | default(domain, true) | default('') }}"

    - name: Compute vhost ServerName fallback
      ansible.builtin.set_fact:
        _vhost_name: "{{ (_hostname and _domain) | ternary(_hostname ~ '.' ~ _domain, (_hostname or _domain or ansible_hostname or inventory_hostname or 'localhost')) }}"

    - name: Compute FQDN when domain is provided
      ansible.builtin.set_fact:
        _fqdn: "{{ _hostname }}.{{ _domain }}"
      when:
        - _hostname | length > 0
        - _domain | length > 0

    - name: Set system hostname
      ansible.builtin.hostname:
        name: "{{ _fqdn | default(_hostname) }}"
      when:
        - _hostname | length > 0

    - name: Ensure /etc/hosts has 127.0.1.1 mapping for hostname
      ansible.builtin.blockinfile:
        path: /etc/hosts
        marker: "# {mark} ANSIBLE ranch-servers hostname"
        block: |
          127.0.1.1 {{ (_fqdn | default(_hostname)) | trim }} {{ _hostname }}
      when:
        - _hostname | length > 0

    # ---------- DOCKER APT REPO (so docker-compose-plugin is available) ----------
    - name: Install Docker repo prerequisites
      ansible.builtin.apt:
        update_cache: yes
        state: present
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release

    - name: Compute Docker repo base (debian/ubuntu)
      ansible.builtin.set_fact:
        docker_repo_base: "{{ 'ubuntu' if ansible_distribution == 'Ubuntu' else 'debian' }}"

    - name: Ensure keyrings directory exists
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Add Docker’s official GPG key
      ansible.builtin.shell: |
        set -e
        curl -fsSL https://download.docker.com/linux/{{ docker_repo_base }}/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        chmod a+r /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg

    - name: Add Docker APT repository
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/docker.list
        mode: "0644"
        content: |
          deb [arch={{ docker_arch_map[ansible_architecture]|default('amd64') }} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/{{ docker_repo_base }} {{ ansible_distribution_release }} stable

    - name: Update apt cache after adding Docker repo
      ansible.builtin.apt:
        update_cache: yes

    # ---------- PACKAGES (WireGuard + everything else; Docker from official repo) ----------
    - name: Install packages
      ansible.builtin.apt:
        state: present
        name:
          - netcat-openbsd
          - wireshark
          - tshark
          - tcpdump
          - apache2
          - certbot
          - python3-certbot-apache
          - openssh-server
          # Docker stack from official repo
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
          # Toolchains & deps
          - build-essential
          - gcc
          - g++
          - mingw-w64
          - git
          - curl
          - jq
          - unzip
          - make
          - libssl-dev
          - zlib1g-dev
          - libbz2-dev
          - libreadline-dev
          - libsqlite3-dev
          - llvm
          - libncursesw5-dev
          - xz-utils
          - tk-dev
          - libxml2-dev
          - libxmlsec1-dev
          - libffi-dev
          - liblzma-dev
          # WireGuard
          - wireguard
          - wireguard-tools
      tags: [packages]

    # ---------- GROUPS ----------
    - name: Ensure docker/wireshark groups exist
      ansible.builtin.group:
        name: "{{ item }}"
        state: present
      loop: [docker, wireshark]
      tags: [users]

    # ---------- USER + KEY ----------
    - name: Create primary user
      ansible.builtin.user:
        name: "{{ primary_user }}"
        groups: "sudo,docker,wireshark"
        append: yes
        shell: /bin/bash
        create_home: yes
        password_lock: no
      tags: [users]

    - name: Load SSH public key (direct string or from path)
      ansible.builtin.set_fact:
        _raw_ssh_pubkey: >-
          {% if ssh_pubkey_path is defined and ssh_pubkey_path|length > 0 %}
          {{ lookup('file', ssh_pubkey_path) }}
          {% else %}
          {{ ssh_pubkey | default('') }}
          {% endif %}
      tags: [users]

    - name: Validate provided SSH public key
      ansible.builtin.assert:
        that:
          - _raw_ssh_pubkey | trim | length > 0
        fail_msg: "ssh_pubkey is empty or not set; pass -e \"ssh_pubkey=$(cat ~/.ssh/id_rsa.pub)\" or -e ssh_pubkey_path=/path/to/key.pub"
      tags: [users]

    - name: Normalize SSH public key to first line
      ansible.builtin.set_fact:
        _ssh_pubkey_line: "{{ _raw_ssh_pubkey.splitlines()[0] | trim }}"
      tags: [users]

    - name: Validate SSH public key format (type + key at minimum)
      ansible.builtin.assert:
        that:
          - _ssh_pubkey_line.split() | length >= 2
        fail_msg: "ssh_pubkey looks malformed; starts with '{{ _ssh_pubkey_line | truncate(80, True, '...') }}'. Pass -e ssh_pubkey_path=/path/to/key.pub to avoid shell quoting issues."
      tags: [users]

    - name: Passwordless sudo for primary user
      ansible.builtin.copy:
        dest: "/etc/sudoers.d/90-{{ primary_user }}"
        content: "{{ primary_user }} ALL=(ALL) NOPASSWD:ALL\n"
        mode: "0440"
      tags: [users]

    - name: Add your SSH public key
      ansible.builtin.authorized_key:
        user: "{{ primary_user }}"
        key: "{{ _ssh_pubkey_line }}"
      tags: [users]

    # ---------- SERVICES ----------
    - name: Enable & start services
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: true
        state: started
      loop: [docker, ssh]
      tags: [services]

    # ---------- WIRESHARK NON-ROOT CAPTURE ----------
    - name: Allow non-root packet capture (Wireshark)
      ansible.builtin.command: setcap cap_net_raw,cap_net_admin+eip /usr/bin/dumpcap
      changed_when: false
      tags: [wireshark]

    # ---------- PYENV + LATEST PYTHON ----------
    - name: Install pyenv (system-wide)
      ansible.builtin.git:
        repo: "https://github.com/pyenv/pyenv.git"
        dest: /usr/local/pyenv
        version: master
      tags: [pyenv]

    - name: Profile for pyenv
      ansible.builtin.copy:
        dest: /etc/profile.d/pyenv.sh
        mode: "0644"
        content: |
          export PYENV_ROOT=/usr/local/pyenv
          export PATH="$PYENV_ROOT/bin:$PATH"
          eval "$(pyenv init -)"
      tags: [pyenv]

    - name: Install the latest CPython via pyenv
      ansible.builtin.shell: |
        set -e
        mkdir -p /var/tmp/pyenv-build
        export TMPDIR=/var/tmp/pyenv-build
        export PYENV_ROOT=/usr/local/pyenv
        export PATH="$PYENV_ROOT/bin:$PATH"
        eval "$(pyenv init -)"
        LATEST=$(pyenv install --list | sed 's/^[[:space:]]*//' | egrep '^[0-9]+\.[0-9]+\.[0-9]+$' | tail -1)
        pyenv install -s "$LATEST"
        pyenv global "$LATEST"
        pyenv rehash
      args:
        creates: /usr/local/pyenv/version
      tags: [pyenv]

    # ---------- APACHE: HTTPS DEFAULT + LE (best-effort) ----------
    - name: Compute vhost hostname/domain (Apache)
      ansible.builtin.set_fact:
        _hostname: "{{ hostvars[inventory_hostname].hostname | default(hostname | default(ansible_hostname | default(inventory_hostname, true), true), true) | default('') }}"
        _domain: "{{ hostvars[inventory_hostname].domain | default(domain | default(''), true) | default('') }}"
      tags: [apache, lets-encrypt]

    - name: Compute vhost ServerName (Apache)
      ansible.builtin.set_fact:
        _vhost_name: >-
          {% if _domain | length > 0 -%}
          {{ _domain }}
          {%- elif _hostname | length > 0 -%}
          {{ _hostname }}
          {%- elif ansible_hostname is defined and (ansible_hostname | length > 0) -%}
          {{ ansible_hostname }}
          {%- elif inventory_hostname is defined and (inventory_hostname | length > 0) -%}
          {{ inventory_hostname }}
          {%- else -%}
          localhost
          {%- endif %}
      tags: [apache, lets-encrypt]

    - name: Enable Apache modules
      ansible.builtin.command: a2enmod ssl headers rewrite
      changed_when: false
      tags: [apache]

    - name: Force HTTP -> HTTPS
      ansible.builtin.copy:
        dest: /etc/apache2/sites-available/000-default.conf
        content: |
          <VirtualHost *:80>
            ServerName {{ _vhost_name }}
            RewriteEngine On
            RewriteCond %{HTTPS} !=on
            RewriteRule ^/(.*)$ https://%{HTTP_HOST}/$1 [R=301,L]
          </VirtualHost>
      tags: [apache]

    - name: Default SSL vhost
      ansible.builtin.stat:
        path: "/etc/letsencrypt/live/{{ _vhost_name }}/fullchain.pem"
      register: le_cert
      tags: [apache]

    - name: Default SSL vhost
      ansible.builtin.copy:
        dest: /etc/apache2/sites-available/default-ssl.conf
        content: |
          <IfModule mod_ssl.c>
            <VirtualHost _default_:443>
              ServerName {{ _vhost_name }}
              DocumentRoot /var/www/html
              SSLEngine on
              SSLCertificateFile {{ le_cert.stat.exists | ternary('/etc/letsencrypt/live/' ~ _vhost_name ~ '/fullchain.pem', '/etc/ssl/certs/ssl-cert-snakeoil.pem') }}
              SSLCertificateKeyFile {{ le_cert.stat.exists | ternary('/etc/letsencrypt/live/' ~ _vhost_name ~ '/privkey.pem', '/etc/ssl/private/ssl-cert-snakeoil.key') }}
              <Directory /var/www/html>
                Require all granted
                Options -Indexes +FollowSymLinks
                AllowOverride All
              </Directory>
              Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
            </VirtualHost>
          </IfModule>
      tags: [apache]

    - name: Enable default-ssl
      ansible.builtin.command: a2ensite default-ssl
      changed_when: false
      tags: [apache]

    - name: Reload Apache
      ansible.builtin.systemd:
        name: apache2
        state: reloaded
      tags: [apache]

    - name: Try Let’s Encrypt (ok if DNS not ready yet)
      ansible.builtin.shell: |
        set -e
        certbot --apache --non-interactive --agree-tos \
          -m "{{ le_email }}" -d "{{ _vhost_name }}" --redirect || true
      args:
        creates: "/etc/letsencrypt/live/{{ _vhost_name }}/fullchain.pem"
      tags: [apache, lets-encrypt]

    - name: Ensure Apache enabled and started
      ansible.builtin.systemd:
        name: apache2
        enabled: true
        state: started
      tags: [apache, services]

    # ---------- FIREWALL: disable local firewall (use provider firewall instead) ----------
    - name: Check if ufw systemd unit exists
      ansible.builtin.stat:
        path: /lib/systemd/system/ufw.service
      register: ufw_unit
      tags: [firewall]

    # ---------- SHELL PROFILE ----------
    - name: Deploy .bashrc for root
      ansible.builtin.copy:
        src: files/.bashrc
        dest: /root/.bashrc
        owner: root
        group: root
        mode: "0644"
      tags: [shell]

    - name: Deploy .bashrc for {{ primary_user }}
      ansible.builtin.copy:
        src: files/.bashrc
        dest: "/home/{{ primary_user }}/.bashrc"
        owner: "{{ primary_user }}"
        group: "{{ primary_user }}"
        mode: "0644"
      tags: [shell]

    # ---------- SSHD CONFIG ----------
    - name: Deploy sshd_config
      ansible.builtin.copy:
        src: files/sshd_config
        dest: /etc/ssh/sshd_config
        owner: root
        group: root
        mode: "0644"
        backup: yes
      notify:
        - Restart SSH
        - Daemon reload
        - Restart SSH socket (Ubuntu only)
      tags: [ssh]

  handlers:
    - name: Restart SSH
      ansible.builtin.systemd:
        name: ssh
        state: restarted
    - name: Daemon reload
      ansible.builtin.systemd:
        daemon_reload: yes
    - name: Restart SSH socket (Ubuntu only)
      ansible.builtin.systemd:
        name: ssh.socket
        state: restarted
      when: ansible_os_family == "Debian" and ansible_distribution == "Ubuntu"
